exp_id = 'exp_metaLearn_01';
exppath_short = 'exp/experiments';
exp_description = 'First experiment with meta-learning models.';

lik = log(0.01);
covBounds = [log([0.01 10]); log([0.01 10])];

modelOptions = { ...
  'gp', { ...
    'hypOptions',         { ...
      struct( ...
        'covFcn',             { '@covSEiso' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '@covSEard' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(std(X))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covMaterniso, 5}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covMaterniso, 3}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covMaterniso, 1}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covMaternard, 5}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(std(X))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covMaternard, 3}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(std(X))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covMaternard, 1}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(std(X))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '@covRQiso' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'; 'log(1)'}} ) }, ...
        'covBounds',          { [covBounds; log([0.01 100])] } ...
      ), ...
      struct( ...
        'covFcn',             { '@covRQard' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(std(X))'; 'log(std(yTrain)/sqrt(2))'; 'log(1)'}} ) }, ...
        'covBounds',          { [covBounds; log([0.01 100])] } ...
      ), ...
      struct( ...
        'covFcn',             { '@covNNone' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))' }} ) }, ...
        'covBounds',          { covBounds } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covPERiso, {@covSEiso}}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(max(range(X))/10)'; 'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { [log(0.01) log(100); covBounds] } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covPERard, {@covSEiso}}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(range(X)./10)'; 'log(mean(std(X)))'; 'log(std(yTrain)/sqrt(2))'}} ) }, ...
        'covBounds',          { [log(0.01) log(100); covBounds] } ...
      ), ...
      struct( ...
        'covFcn',             { '{@covADD, {[1, 2, 3, 5, 7, 10], @covSEisoU}}' }, ...
        'hyp',                { struct('lik', lik, ...
                                       'cov', {{'log(mean(std(X)))'; 0.1}} ) }, ...
        'covBounds',          { [log([0.01 10]); [0 10]] } ...
      ), ...
    }, ...
    'meanFcn',            { 'meanConst' }, ...
    'trainAlgorithm',     { 'fmincon' }, ...
    'predictionType',     { 'fvalues' }, ...
    'useShift',           { false }, ...
    'normalizeY',         { true }, ...
    'nRestarts',          { 2 }, ...
  }, ...
  'forest', { ...
    'forestType',          { 'bagging' }, ...
    'rf_nTrees',           { 100 }, ...
    'rf_boosting',         { false }, ...
    'rf_inBagFraction',    { 1 }, ...
    'tree_growFull',       { true }, ...
    'tree_predictorFunc',  { @CombiPolynomialModel }, ...
    'tree_minParentSize',  { 4 }, ...
    'weak_modelSpec',      { {'constant', 'linear', 'purequadratic', 'interactions', 'quadratic'} }, ...
    'tree_splitFunc',      { @AxisSplit, @GaussianSplit, @HillClimbingObliqueSplit, @KMeansSplit, @PairObliqueSplit, @ResidualObliqueSplit }, ...
    'tree_splitGainFunc',  { @DEMSDSplitGain, @DENNSplitGain, @DESplitGain, @MSESplitGain, @VarSplitGain }, ...
    'splitGain_modelFunc', { @CombiPolynomialModel }, ...
    'split_nQuantize' ,    { 10 }
  }, ...
  'forest', { ...
    'forestType',          { 'xgboost' }, ...
    'rf_nTrees',           { 100 }, ...
    'rf_boosting',         { true }, ...
    'rf_inBagFraction',    { 1 }, ...
    'tree_growFull',       { true }, ...
    'tree_predictorFunc',  { @ConstantModel }, ...
    'tree_minParentSize',  { 4 }, ...
    'weak_modelSpec',      { 'constant' }, ...
    'tree_splitFunc',      { @AxisSplit, @GaussianSplit, @HillClimbingObliqueSplit, @KMeansSplit, @PairObliqueSplit, @ResidualObliqueSplit }, ...
    'tree_splitGainFunc',  { @GradientSplitGain }, ...
    'splitGain_modelFunc', { @Constant }, ...
    'split_nQuantize' ,    { 10 }
  } ...
};

opts.modelTypes = { 'rf', 'gp' };

% CV settings
opts.cv_type = 'KFold';
opts.cv_param = 10;
opts.cv_ind = 1:opts.cv_param;

% the CV can be run in a parallel worker pool
opts.use_parpool = true;

% RNG options
opts.use_rng_seed = true;
opts.rng_seed = 42;

% I/O
opts.fname_template = strjoin({'data_metalearn_', ...
  '%dD_', ...
  'f%d_', ...
  'inst%d_', ...
  'N%d_', ...
  'design-%s.mat'}, '' ...
);
opts.dataset_path = 'data_metalearning';

% logDir = '/storage/plzen1/home/repjak/public';
